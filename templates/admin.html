<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | pgConf Check-in</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .chart-container { display: flex; flex-wrap: wrap; }
        .chart { width: 48%; margin: 1%; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Admin Panel</h1>
    <a href="/logout" style="float: right;">Logout</a>

    <div class="chart-container">
        <div id="movementChart" class="chart"></div>
        <div id="locationChart" class="chart"></div>
    </div>

    <h2>Recent Check-Ins</h2>
    <table id="checkinsTable">
        <thead>
            <tr>
                <th>Volunteer</th>
                <th>Attendee</th>
                <th>Location</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>User Management</h2>
<form action="/admin/add_user" method="POST" style="margin-bottom: 20px;">
    <input type="text" name="username" placeholder="New username" required>
    <input type="password" name="password" placeholder="Password" required>
    <button type="submit">Add User</button>
</form>

<table>
    <thead>
        <tr>
            <th>Username</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for user in all_users %}
        <tr>
            <td>{{ user.username }}</td>
            <td>
                <form action="/admin/delete_user/{{ user.username }}" method="POST"
                      onsubmit="return confirm('Delete this user?')" style="display: inline;">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
    <script>
        async function loadData() {
            const response = await fetch('/api/admin/checkins');
            const data = await response.json();

            // Update table
            const tableBody = document.querySelector('#checkinsTable tbody');
            tableBody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.username}</td>
                    <td>${item.attendee}</td>
                    <td>${item.location}</td>
                    <td>${new Date(item.time).toLocaleString()}</td>
                </tr>
            `).join('');

            // Prepare data for charts
            const locations = {};
            const userMovements = {};

            data.forEach(item => {
                // Count by location
                locations[item.location] = (locations[item.location] || 0) + 1;

                // Track user movement
                if (!userMovements[item.attendee]) {
                    userMovements[item.attendee] = [];
                }
                userMovements[item.attendee].push({
                    location: item.location,
                    time: new Date(item.time)
                });
            });

            // Draw location chart
            Plotly.newPlot('locationChart', [{
                values: Object.values(locations),
                labels: Object.keys(locations),
                type: 'pie'
            }], { title: 'Current Distribution by Location' });

            // Draw movement chart (example for first user)
            const sampleUser = Object.keys(userMovements)[0];
            if (sampleUser) {
                const movementData = userMovements[sampleUser]
                    .sort((a, b) => a.time - b.time);

                Plotly.newPlot('movementChart', [{
                    x: movementData.map(m => m.time),
                    y: movementData.map(m => m.location),
                    mode: 'lines+markers',
                    type: 'scatter'
                }], { title: `Movement of ${sampleUser}` });
            }
        }

        // Load data initially and every 30 seconds
        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
